<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Stash Hub</title>

    <!-- CSS Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

    <!-- CSS -->
    <link rel="stylesheet" th:href="@{/css/styles.css}" />
</head>
<body>

<div class="container my-5">
    <header class="text-center mb-5">
        <h1 class="display-5 fw-light">Stash Hub</h1>
        <h6 class="display-5 fw-light">a place of structured chaos</h6>
    </header>

    <!-- Форма добавления заметки -->
    <div class="my-4" style="padding-left: 0;">
        <button type="button"
                class="btn btn-link text-decoration-none p-0"
                data-bs-toggle="modal"
                data-bs-target="#addModal">
            + Добавить запись
        </button>
    </div>

    <!-- Модальное окно: добавление заметки -->
    <div class="modal fade" id="addModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Новая запись</h5>
                </div>
                <div class="modal-body">
                    <form th:action="@{/ui/stash}" th:object="${stashItem}" method="post">
                        <div class="mb-3">
                            <input type="text" th:field="*{title}" placeholder="Заголовок" class="form-control" required />
                        </div>
                        <div class="mb-3">
                            <textarea th:field="*{body}" placeholder="Текст заметки" class="form-control" rows="5"></textarea>
                        </div>
                        <div class="mb-3">
                            <input type="text" th:field="*{tag}" placeholder="#Тег" class="form-control"
                                   list="tagSuggestions" th:value="${stashItem?.tag}"/>
                        </div>
                        <datalist id="tagSuggestions">
                            <option th:each="tag : ${tags}" th:value="${tag}" />
                        </datalist>
                        <input type="text" name="category" id="categoryInput" placeholder="Группа/категория" class="form-control"
                               list="categorySuggestions" th:value="${stashItem?.category}" />
                        <datalist id="categorySuggestions">
                            <option th:each="category : ${categories}" th:value="${category}" />
                        </datalist>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-subtle btn-sm" data-bs-dismiss="modal">Отмена</button>
                            <button type="submit" class="btn btn-subtle btn-sm">Сохранить</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Список заметок -->
    <div th:if="${!items.empty}">
        <div th:each="entry : ${categoryItems}" class="mb-4">
            <!-- Аккордеон для группы -->
            <div class="accordion">
                <div class="accordion-item category">
                    <h2 class="accordion-header" th:id="'group-heading-' + ${entry.key}">
                        <button class="accordion-button category-header d-flex align-items-center"
                                type="button"
                                data-bs-toggle="collapse"
                                th:attr="data-bs-target='#group-collapse-' + ${entry.key}, aria-controls='group-collapse-' + ${entry.key}"
                                th:classappend="${entry.key == 'Inbox'} ? '' : 'collapsed'">
                            <span th:text="${entry.key == 'Inbox' ? '— ' + entry.key : '– ' + entry.key}"></span>
                        </button>
                    </h2>
                    <div th:id="'group-collapse-' + ${entry.key}"
                         class="accordion-collapse"
                         th:classappend="${entry.key == 'Inbox' ? 'show' : 'collapse'}"
                         th:attr="aria-labelledby='group-heading-' + ${entry.key}">
                        <div class="accordion-body p-0">
                            <div class="accordion" style="border: none;">
                                <div th:each="item : ${entry.value}" class="accordion-item">
                                    <h2 class="accordion-header" th:id="'heading-' + ${item.id}">
                                        <button class="accordion-button collapsed d-flex justify-content-between align-items-center" type="button"
                                                data-bs-toggle="collapse"
                                                th:data-bs-target="'#collapse-' + ${item.id}"
                                                th:aria-controls="'heading-' + ${item.id}"
                                                aria-expanded="false">
                                            <!-- Заголовок группы-->
                                            <span class="fw-normal" th:text="${item.title}"></span>
                                        </button>
                                    </h2>
                                    <div th:id="'collapse-' + ${item.id}"
                                         class="accordion-collapse collapse"
                                         th:aria-labelledby="'heading-' + ${item.id}">
                                        <div class="accordion-body">
                                            <!-- Дата создания -->
                                            <small class="note-date">[[${#temporals.format(item.created, 'dd.MM.yyyy HH:mm')}]]</small>
                                            <!-- Текст заметки -->
                                            <pre th:text="${item.body}" class="note-body"></pre>
                                            <!-- Теги -->
                                            <div class="note-tags" th:if="${item.tag}">
                                                <small class="note-tag-label">[[${item.tag}]]</small>
                                            </div>
                                            <!-- Кнопки редактирования и удаления -->
                                            <div class="d-flex gap-2">
                                                <button type="button" class="btn btn-subtle btn-sm"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#updateModal"
                                                        th:data-id="${item.id}"
                                                        th:data-title="${item.title}"
                                                        th:data-body="${item.body}"
                                                        th:data-tag="${item.tag}"
                                                        th:data-category="${item.category}">
                                                    Редактировать
                                                </button>
                                                <button type="button" class="btn btn-subtle btn-sm"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#confirmDeleteModal"
                                                        th:data-id="${item.id}">
                                                    Удалить
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Если заметок нет -->
                <div th:if="${items.empty}" class="empty-state">
                    <em>Пока нет ни одной заметки. Добавь первую — может быть, это будет важная мысль.</em>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно: подтверждение удаления -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center pb-0">
                    <p>Удалить эту запись?</p>
                </div>
                <div class="modal-footer justify-content-center border-0 pb-3 pt-2">
                    <button type="button" class="btn btn-subtle btn-sm me-2" data-bs-dismiss="modal">Отмена</button>
                    <form id="deleteForm" method="post" style="display: inline;">
                        <button type="submit" class="btn btn-subtle btn-sm">Удалить</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно: редактирование -->
    <div class="modal fade" id="updateModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Редактировать запись</h5>
                </div>
                <div class="modal-body">
                    <form id="updateForm" method="post">
                        <div class="mb-3">
                            <input type="text" name="title" id="updateTitle" placeholder="Заголовок" class="form-control" required />
                        </div>
                        <div class="mb-3">
                            <textarea name="body" id="updateBody" placeholder="Текст" class="form-control" rows="5"></textarea>
                        </div>
                        <div class="mb-3">
                            <input type="text" name="tag" id="updateTag" placeholder="#Тег" class="form-control" list="tagSuggestions"/>
                        </div>
                        <input type="text" name="category" id="updateCategory" class="form-control"
                               list="categorySuggestions" placeholder="Группа/категория" />
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-subtle btn-sm" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" form="updateForm" class="btn btn-subtle btn-sm">Сохранить</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Скрипты -->
    <script th:inline="javascript">
        /*<![CDATA[*/
            const items = /*[[${items}]]*/ [];
        /*]]>*/
    </script>

    <script>
        // Удаление
        document.getElementById('confirmDeleteModal').addEventListener('show.bs.modal', event => {
            const button = event.relatedTarget;
            const id = button.getAttribute('data-id');
            document.getElementById('deleteForm').action = `/ui/stash/delete/${id}`;
        });

        // Редактирование
        document.getElementById('updateModal').addEventListener('show.bs.modal', event => {
            const button = event.relatedTarget;
            document.getElementById('updateTitle').value = button.getAttribute('data-title');
            document.getElementById('updateBody').value = button.getAttribute('data-body');
            document.getElementById('updateTag').value = button.getAttribute('data-tag');
            document.getElementById('updateForm').action = `/ui/stash/update/${button.getAttribute('data-id')}`;
            document.getElementById('updateCategory').value = button.getAttribute('data-category') || 'Inbox';
        });
    </script>

</body>
</html>